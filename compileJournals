import openpyxl
import time as tt
import datetime as dt
import re
import os
import sys
'''
def findFiles(cwd):
def createJournal(cwd):
def compileFile(jList,config,journal,cwd):
def readWriteConfig(conf,mode,dict = None):
'''

'''	
def compileFile(jList,config,journal,cwd): #by rows
	workbook = openpyxl.load_workbook(journal)
	#wb = op.load_workbook('/tmp/test.xlsx', use_iterators=True) без этого может не работать итератор
#########check configuration info : get last row for every user in their files
	if os.stat(config).st_size == 0:
		startPos = 0
	else:
		userConf = readWriteConfig(config,True)
###############################################################################
#append new row in journal  
	for jItem in jList:
		wb = openpyxl.load_workbook(jItem,read_only=True)
		for sheet in wb.sheetnames:
			userName = sheet.split('_')[1]   #example : DD_NAME
			sheetName = sheet.split('_')[0]  #example : DTE_NAME
			startPos = userConf[userName]
			endPos = sheet.max_row
			#sheetFromCopy = actually sheetName
			sheetToCopy = workbook.get_sheet_by_name(sheetName)
			for row in sheet.iter_rows(row_offset=1, min_row = startPos,max_row = endPos):
				row+= userName
				#row.styles - вероятно придется писать итераторы для ячеек, чтоб переносить с сохранением стилей.
				#или написать перенос по строкам и автоматическое заполнение стилей по содержимому ячеек (на чито время хватит)
				sheetToCopy.append(row)
			
				
	return None #
'''

def findFiles(cwd):
	currentYear = datetime.date.today().year
	xlFiles = [f for f in os.listdir(cwd) if isfile(os.join(cwd, f))]
	xlFiles = [lambda x: re.search(r'.*ДТЭ.*%s.*xlsm' %currentYear, xlFiles).group(0)]
	for item in xlFiles:
		if re.search(r'.*Сводный_журнал_ДТЭ.*%s.*xlsm' %currentYear, item) == None:
			createJournal(cwd)
		else:
			cJournal = item
			xlFiles.pop(xlFiles.index(item))
	for file in os.listdir(cwd):
		if file.endswith("config.txt"):
			comfigFile = os.join(cwd,file)
	return xlFiles,config, cJournal

def createJournal(cwd):
	wb = openpyxl.Workbook()
	wb.create_sheet('ДД')
	wb.create_sheet('ДТЭ')
	currentYear = datetime.date.today().year
	wb.save(cwd+'\\Сводйный_журнал_ДТЭ_%s.xlsm' %currentYear)
	f = open('config.txt', 'tw', encoding='utf-8')
	f.close()

def readWriteConfig(conf,mode,dict = None):
	if mode:
		cfgDict = {}	
		with open(conf,'r') as cfg:
			for line in cfg:
				cfgDict[line.split('-')[0]] = [line.split('-')[1],line.split('-')[2]]
	else:
		open(conf, 'w').close() #clear config file
		with open(conf,'a') as cfg:
			for key in dict:
				cfg.write('%s-%s\n' %(key, dict[key]))
	
def compileFile(jList,config,journal,cwd): #by cells
	workbook = openpyxl.load_workbook(journal)
	#wb = op.load_workbook('/tmp/test.xlsx', use_iterators=True) без этого может не работать итератор
	if os.stat(config).st_size == 0:
		startPos = 0
	else:
		userConf = readWriteConfig(config,True)
	for jItem in jList: #append new row in journal  
		wb = openpyxl.load_workbook(jItem,read_only=True)
		for sheet in wb.sheetnames:
			userName = sheet.split('_')[1]   #example : DD_NAME
			sheetName = sheet.split('_')[0]  #example : DTE_NAME
			startPosRow = userConf[userName]+1
			endPosCol = sheet.max_column 
			startPosRowToCopy = wb.max_row + 1 #get first empty row in book
			sheetToCopy = workbook.get_sheet_by_name(sheetName) #copy cells to the same sheet in new workbook
			for row in sheet.iter_rows(row_offset=1, min_row = startPos,max_row = endPos):
				for cell in row:
					newCell = sheetToCopy.cell(row = startPosRowToCopy,column = cell.col_idx, value = cell.value)
					if cell.has_style: #get and copy cell style if it possible
						new_cell.font = copy(cell.font)
						new_cell.border = copy(cell.border)
						new_cell.fill = copy(cell.fill)
						new_cell.number_format = copy(cell.number_format)
						new_cell.protection = copy(cell.protection)
						new_cell.alignment = copy(cell.alignment)
				startPosRowToCopy+=1
		readWriteConfig(config,False,userConf)
	return None # ¯\_(ツ)_/¯
	
def main():
	workDir = os.getcwd()
	journalList,configFile,journalFile = findFiles(workDir)
	compileFile(journalList,configFile,journalFile,workDir)
	
if __name__ == '__main__':
	main()
